function executeElementStatus(e,t){t?$(e).fadeIn(250):$(e).fadeOut(250)}function executeResponses(e){var t=$("#action-select");if(t.length){var a=t[0].selectize;for(var n in a.options){var o=a.options[n];"responses"==o.optgroup&&a.removeOption(n)}if(a.removeOptionGroup("responses"),Object.keys(e).length>0){a.addOptionGroup("responses",{id:"action-responses",label:"Responses"});for(var s in e)a.addOption({value:"r-"+s,icon:"comment",text:e[s],optgroup:"responses"})}}}function executeLocaleAct(){$.ajax("/q/localeact").done(function(e){console.log(e);var t=$("#action-select");if(t.length){var a=t[0].selectize;a.clearOptionGroups(),a.clearOptions(),console.log(e.actions);var n=[];for(var o in e.actions){var s=e.actions[o];console.log(s),s.optgroup in n||(a.addOptionGroup(s.optgroup,{id:"action-"+s.optgroup,label:s.optlabel}),n.push(s.optgroup)),a.addOption({value:s.value,icon:s.icon,text:s.text,optgroup:s.optgroup})}"responses"in e&&executeResponses(e.responses)}})}function executeLocaleTravel(){$.ajax("/q/localetravel").done(function(e){console.log(e);var t=$("#travel-select");if(t.length){var a=t[0].selectize;a.clearOptions(),console.log(e.linked);var n=!1;for(var o in e.linked){var s=e.linked[o];console.log(s),a.addOption({value:s.value,text:s.name}),n||(n=!0,a.setValue(s.value,!0))}}})}function executeActStatus(e){var t=$("#action-select");if(t.length){var a=t[0].selectize;e?a.unlock():a.lock()}}function executeStartCombat(){combat=!0,$("#travelModalRevealer").addClass("disabled"),$.ajax("/q/startcombat").done(function(e){$("#content").fadeOut(400,function(){$("#menu").find("a.active").each(function(){$(this).removeClass("active")}),$("#game").addClass("active").html('<i class="fa fa-crosshairs"></i><br/>Combat'),$("#content").html(e).fadeIn(400,function(){$("#central.messages").scrollTop($("#central.messages").prop("scrollHeight")),$(".skill-box").find("img").click(function(){$(this).hasClass("recharge")||($(".skill-box").find("img.selected").each(function(){$(this).removeClass("selected")}),$(".skill-box").find("img.invalid").each(function(){$(this).removeClass("invalid")}),$(this).closest(".row").find("img.active").each(function(){$(this).removeClass("active"),delete combatmem[$(this).parent().attr("id")]}),$(this).addClass("selected"))}),$(".combat-target").click(function(){var e=$(this).attr("id");$(".skill-box").find("img.selected").each(function(){$(this).removeClass("selected").addClass("active"),combatmem[$(this).parent().attr("id")]=e})}),$("#turn-end").click(function(){console.log("TURN END"),executeCombat(!1)})}),setupPage(),executeLocaleAct(),$("#enemies-first").length>0&&executeCombat(!0)})})}function executeCombat(e){var t={};e||(t=combatmem),$.ajax("/q/combatact",{type:"POST",data:t}).done(function(e){executeCommands(e.commands,0)})}function executeCombatUpdate(e){console.log(e);for(var t in e){var a=e[t];"enemy"==a.target.substring(0,6)?("health"==a.source||"energy"==a.source)&&$("#"+a.target).find(".enemy-"+a.source).find(".progress").attr("aria-valuenow",a.value).attr("aria-valuetext",a.percent+" percent "+a.source).find(".meter").css("width",a.percent+"%").find(".meter-text").text(a.percent+"%"):"player"==a.target.substring(0,6)&&("health"==a.source||"energy"==a.source)&&$("#"+a.target).find(".player-"+a.source).find(".progress").attr("aria-valuenow",a.value).attr("aria-valuetext",a.value+" "+a.source).find(".meter").css("width",a.percent+"%").find(".meter-text").text(a.value)}}function executeEndCombat(){combat=!1,$("#game").html('<i class="fa fa-gamepad"></i><br/>Game').trigger("click"),setTimeout(function(){$.ajax("/q/endcombat").done(function(e){e&&executeCommands(e.commands,0)})},1e3)}function executeMsg(e,t,a){if($("#central.messages").length){var n='<div class="message '+a+'">';e&&(n+='<span class="sender">'+e+":</span> "),n+=t+"</div>",$("#central.messages").append(n).animate({scrollTop:$("#central.messages").prop("scrollHeight")},"fast")}}function executeCommands(e,t){if(e.length>t){var a=e[t];console.log(a),"central"==a.type||("status"==a.type?executeElementStatus(a.element,a.status):"responses"==a.type?executeResponses(a.responses):"msg"==a.type||"cmsg"==a.type?"eclass"in a?executeMsg(a.sender,a.msg,a.eclass):executeMsg(a.sender,a.msg,""):"localeact"==a.type?executeLocaleAct():"localetravel"==a.type?executeLocaleTravel():"location"==a.type?$("#travelModalRevealer").find("span").text(a.name):"actbarstatus"==a.type?executeActStatus(a.status):"combat"==a.type?executeStartCombat():"combatupdate"==a.type&&executeCombatUpdate(a.updates)),"time"in a&&a.time>0?(console.log(a.time),setTimeout(function(){executeCommands(e,t+1)},a.time)):(console.log(0),executeCommands(e,t+1))}}function setupPage(){$("#game").hasClass("active")&&!combat?$("#travelModalRevealer").removeClass("disabled"):$("#travelModalRevealer").addClass("disabled");var e=$("#action-select");e.length&&e.selectize({render:{option:function(e,t){return'<div class="option"><span class="icon"><i class="fa fa-'+t(e.icon)+'" /> </span><span class="title">'+t(e.text)+"</span></div>"}},onChange:function(e){e&&$.ajax("/q/act",{type:"POST",data:{value:e}}).done(function(e){executeCommands(e.commands,0)})}}),$(".player-unequip").click(function(){$.ajax("/q/punequip",{type:"POST",data:{skill:$(this).attr("id")}}).done(function(){Tipped.init(),$("#character").trigger("click")})}),$(".player-equip").click(function(){$.ajax("/q/pequip",{type:"POST",data:{skill:$(this).attr("id")}}).done(function(){Tipped.init(),$("#character").trigger("click")})}),Tipped.create(".inventory-item-filled",function(e){return{title:$(e).find(".tipped-title").html(),content:$(e).find(".tipped-content").html()}},{skin:"light"}),Tipped.create(".skill-filled",function(e){return{title:$(e).find(".tipped-title").html(),content:$(e).find(".tipped-content").html()}},{skin:"light"})}var combat=!1,combatmem={};jQuery(document).ready(function(){setInterval("updateClock()",1e3),setupPage(),$("#central.messages").scrollTop($("#central.messages").prop("scrollHeight")),$("#menu").find("a").click(function(){if(!combat){var e=$(this).attr("id");$.ajax("/q/menu",{type:"GET",data:{menu:e}}).done(function(t){$("#content").fadeOut(400,function(){$("#menu").find("a.active").each(function(){$(this).removeClass("active")}),$("#"+e).addClass("active"),$("#content").html(t).fadeIn(400,function(){$("#central.messages").scrollTop($("#central.messages").prop("scrollHeight"))}),setupPage(),executeLocaleAct()})})}}),$("#travelModalRevealer").click(function(){$(this).hasClass("disabled")||$("#travelModal").foundation("reveal","open")});var e=$("#travel-select").selectize();$(".shoeprints").find("a").click(function(){$.ajax("/q/travel",{type:"GET",data:{key:e[0].selectize.getValue()}}).done(function(e){$("#travelModal").foundation("reveal","close"),e&&executeCommands(e.commands,0)})}),$.ajax("/q/start").done(function(e){e&&executeCommands(e.commands,0)})});